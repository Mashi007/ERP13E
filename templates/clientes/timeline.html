<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline de Clientes - ERP13 Enterprise</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #8B5CF6;
            --secondary-color: #3B82F6;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --dark-color: #1F2937;
            --light-color: #F9FAFB;
        }

        body {
            background-color: var(--light-color);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .sidebar {
            background: linear-gradient(135deg, var(--dark-color) 0%, #374151 100%);
            min-height: 100vh;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-item {
            color: #D1D5DB;
            padding: 12px 20px;
            text-decoration: none;
            display: block;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 4px 8px;
        }

        .sidebar-item:hover, .sidebar-item.active {
            background-color: var(--primary-color);
            color: white;
            transform: translateX(5px);
        }

        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin: 20px;
            min-height: calc(100vh - 40px);
        }

        .timeline-container {
            position: relative;
            padding: 20px 0;
        }

        .timeline {
            position: relative;
            max-width: 100%;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 0;
            left: 30px;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding-left: 80px;
            opacity: 0;
            transform: translateX(-20px);
            animation: fadeInLeft 0.6s ease forwards;
        }

        .timeline-item:nth-child(even) {
            animation-delay: 0.1s;
        }

        .timeline-item:nth-child(odd) {
            animation-delay: 0.2s;
        }

        .timeline-icon {
            position: absolute;
            left: 18px;
            top: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            z-index: 2;
        }

        .timeline-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .timeline-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .timeline-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 5px;
        }

        .timeline-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.875rem;
            color: #6B7280;
        }

        .timeline-meta .item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .event-type-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-communication { background: #DBEAFE; color: #1E40AF; }
        .event-proposal { background: #D1FAE5; color: #065F46; }
        .event-meeting { background: #FEF3C7; color: #92400E; }
        .event-ticket { background: #FEE2E2; color: #991B1B; }
        .event-campaign { background: #F3E8FF; color: #7C2D12; }
        .event-automation { background: #F0FDF4; color: #166534; }

        .client-filter-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            margin-bottom: 25px;
        }

        .milestone-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 12px;
            padding: 15px;
            color: white;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            color: #6B7280;
            font-size: 0.875rem;
            margin-top: 5px;
        }

        .filter-controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        @keyframes fadeInLeft {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .empty-timeline {
            text-align: center;
            padding: 60px 20px;
            color: #9CA3AF;
        }

        .empty-timeline i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .impact-score {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .impact-high { background: #D1FAE5; color: #065F46; }
        .impact-medium { background: #FEF3C7; color: #92400E; }
        .impact-low { background: #F3F4F6; color: #374151; }

        .related-entities {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #E5E7EB;
        }

        .entity-tag {
            display: inline-block;
            background: #F3F4F6;
            color: #374151;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="p-3">
                    <h4 class="text-white mb-4">
                        <i class="fas fa-users"></i> Clientes
                    </h4>
                    
                    <nav>
                        <a href="{{ url_for('clientes.gestion_clientes') }}" class="sidebar-item">
                            <i class="fas fa-users-cog"></i> Gestión Clientes
                        </a>
                        <a href="{{ url_for('clientes.timeline_clientes') }}" class="sidebar-item active">
                            <i class="fas fa-clock"></i> Timeline
                        </a>
                        <a href="{{ url_for('clientes.comunicaciones_clientes') }}" class="sidebar-item">
                            <i class="fas fa-comments"></i> Comunicaciones
                        </a>
                        <a href="{{ url_for('clientes.propuestas_clientes') }}" class="sidebar-item">
                            <i class="fas fa-file-alt"></i> Propuestas
                        </a>
                        <a href="{{ url_for('clientes.pipeline_clientes') }}" class="sidebar-item">
                            <i class="fas fa-chart-line"></i> Pipeline
                        </a>
                        <a href="{{ url_for('clientes.tickets_clientes') }}" class="sidebar-item">
                            <i class="fas fa-ticket-alt"></i> Tickets
                        </a>
                        <a href="{{ url_for('clientes.calendario_clientes') }}" class="sidebar-item">
                            <i class="fas fa-calendar-alt"></i> Calendario
                        </a>
                        <a href="{{ url_for('clientes.campanas_clientes') }}" class="sidebar-item">
                            <i class="fas fa-bullhorn"></i> Campañas Publicitarias
                        </a>
                        <a href="{{ url_for('clientes.automatizaciones_clientes') }}" class="sidebar-item">
                            <i class="fas fa-magic"></i> Automatizaciones
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="main-content">
                    <div class="p-4">
                        <!-- Header -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2 class="mb-1">
                                    <i class="fas fa-clock text-primary"></i> Timeline
                                    {% if selected_client %}
                                        - {{ selected_client.nombre_empresa }}
                                    {% endif %}
                                </h2>
                                <p class="text-muted mb-0">
                                    {% if selected_client %}
                                        Línea de tiempo de interacciones con {{ selected_client.nombre_empresa }}
                                    {% else %}
                                        Línea de tiempo de todas las interacciones del sistema
                                    {% endif %}
                                </p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#timelineFiltersModal">
                                    <i class="fas fa-filter"></i> Filtros Avanzados
                                </button>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newEventModal">
                                    <i class="fas fa-plus"></i> Nuevo Evento
                                </button>
                            </div>
                        </div>

                        <!-- Client Filter -->
                        <div class="client-filter-card">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h5 class="mb-2">
                                        <i class="fas fa-user-circle"></i> 
                                        {% if selected_client %}
                                            Cliente Seleccionado
                                        {% else %}
                                            Seleccionar Cliente
                                        {% endif %}
                                    </h5>
                                    <div class="d-flex align-items-center gap-3">
                                        <select id="client-selector" class="form-select" style="max-width: 400px;">
                                            <option value="">Ver timeline de todos los clientes</option>
                                            {% for client in clients %}
                                            <option value="{{ client.id }}" {% if selected_client_id == client.id %}selected{% endif %}>
                                                {{ client.nombre_empresa }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        {% if selected_client %}
                                        <div class="text-white">
                                            <strong>{{ selected_client.nombre_empresa }}</strong><br>
                                            <small class="opacity-75">{{ selected_client.sector or 'Sin sector' }} • {{ selected_client.estado or 'Activo' }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fs-3 fw-bold">{{ timeline_events|length }}</div>
                                    <div class="opacity-75">eventos registrados</div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ timeline_events|selectattr("event_type", "equalto", "communication")|list|length }}</div>
                                <div class="stat-label">Comunicaciones</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">{{ timeline_events|selectattr("event_type", "equalto", "proposal")|list|length }}</div>
                                <div class="stat-label">Propuestas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">{{ timeline_events|selectattr("event_type", "equalto", "meeting")|list|length }}</div>
                                <div class="stat-label">Reuniones</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">{{ timeline_events|selectattr("event_type", "equalto", "ticket")|list|length }}</div>
                                <div class="stat-label">Tickets</div>
                            </div>
                        </div>

                        <!-- Filter Controls -->
                        <div class="filter-controls">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center gap-3 flex-wrap">
                                        <div>
                                            <label class="form-label mb-0 small fw-semibold">Tipo de Evento:</label>
                                            <select class="form-select form-select-sm" id="filter-event-type" style="width: 150px;">
                                                <option value="">Todos</option>
                                                <option value="communication">Comunicaciones</option>
                                                <option value="proposal">Propuestas</option>
                                                <option value="meeting">Reuniones</option>
                                                <option value="ticket">Tickets</option>
                                                <option value="campaign">Campañas</option>
                                                <option value="automation">Automatizaciones</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="form-label mb-0 small fw-semibold">Período:</label>
                                            <select class="form-select form-select-sm" id="filter-period" style="width: 130px;">
                                                <option value="">Todo el tiempo</option>
                                                <option value="7">Última semana</option>
                                                <option value="30">Último mes</option>
                                                <option value="90">Últimos 3 meses</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="form-label mb-0 small fw-semibold">Impacto:</label>
                                            <select class="form-select form-select-sm" id="filter-impact" style="width: 120px;">
                                                <option value="">Todos</option>
                                                <option value="high">Alto</option>
                                                <option value="medium">Medio</option>
                                                <option value="low">Bajo</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="search-timeline" placeholder="Buscar en timeline...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Timeline Container -->
                        <div class="timeline-container">
                            {% if timeline_events %}
                            <div class="timeline">
                                {% for event in timeline_events %}
                                <div class="timeline-item" 
                                     data-event-type="{{ event.event_type or '' }}"
                                     data-impact="{{ event.impact_score or 'medium' }}"
                                     data-date="{{ event.event_date or '' }}">
                                    
                                    <!-- Timeline Icon -->
                                    <div class="timeline-icon 
                                        {% if event.event_type == 'communication' %}bg-primary
                                        {% elif event.event_type == 'proposal' %}bg-success
                                        {% elif event.event_type == 'meeting' %}bg-warning
                                        {% elif event.event_type == 'ticket' %}bg-danger
                                        {% elif event.event_type == 'campaign' %}bg-info
                                        {% elif event.event_type == 'automation' %}bg-dark
                                        {% else %}bg-secondary{% endif %}">
                                        
                                        {% if event.event_type == 'communication' %}
                                            <i class="fas fa-comment"></i>
                                        {% elif event.event_type == 'proposal' %}
                                            <i class="fas fa-file-alt"></i>
                                        {% elif event.event_type == 'meeting' %}
                                            <i class="fas fa-calendar"></i>
                                        {% elif event.event_type == 'ticket' %}
                                            <i class="fas fa-ticket-alt"></i>
                                        {% elif event.event_type == 'campaign' %}
                                            <i class="fas fa-bullhorn"></i>
                                        {% elif event.event_type == 'automation' %}
                                            <i class="fas fa-magic"></i>
                                        {% else %}
                                            <i class="fas fa-circle"></i>
                                        {% endif %}
                                    </div>

                                    <!-- Timeline Content -->
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center gap-2 mb-2">
                                                    <h6 class="timeline-title mb-0">{{ event.description or 'Evento sin descripción' }}</h6>
                                                    <span class="event-type-badge event-{{ event.event_type or 'other' }}">
                                                        {{ event.event_type or 'otro' }}
                                                    </span>
                                                    {% if event.impact_score %}
                                                    <span class="impact-score impact-{{ event.impact_score or 'medium' }}">
                                                        Impacto: {{ event.impact_score|title or 'Medio' }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="timeline-meta">
                                                    <div class="item">
                                                        <i class="fas fa-calendar-alt"></i>
                                                        <span>{{ moment(event.event_date).format('DD/MM/YYYY HH:mm') if moment and event.event_date else event.event_date }}</span>
                                                    </div>
                                                    {% if event.nombre_empresa and not selected_client %}
                                                    <div class="item">
                                                        <i class="fas fa-building"></i>
                                                        <span>{{ event.nombre_empresa }}</span>
                                                    </div>
                                                    {% endif %}
                                                    {% if event.triggered_by_name %}
                                                    <div class="item">
                                                        <i class="fas fa-user"></i>
                                                        <span>{{ event.triggered_by_name }}</span>
                                                    </div>
                                                    {% endif %}
                                                    {% if event.duration_minutes %}
                                                    <div class="item">
                                                        <i class="fas fa-clock"></i>
                                                        <span>{{ event.duration_minutes }} min</span>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#"><i class="fas fa-eye"></i> Ver detalles</a></li>
                                                    <li><a class="dropdown-item" href="#"><i class="fas fa-edit"></i> Editar evento</a></li>
                                                    <li><a class="dropdown-item" href="#"><i class="fas fa-link"></i> Ver relacionado</a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-trash"></i> Eliminar</a></li>
                                                </ul>
                                            </div>
                                        </div>

                                        {% if event.event_details %}
                                        <div class="mb-3">
                                            <p class="text-muted mb-0">{{ event.event_details }}</p>
                                        </div>
                                        {% endif %}

                                        {% if event.business_value_impact or event.revenue_impact %}
                                        <div class="row">
                                            {% if event.business_value_impact %}
                                            <div class="col-md-6">
                                                <div class="small">
                                                    <strong>Valor de Negocio:</strong>
                                                    <div class="progress mt-1" style="height: 6px;">
                                                        <div class="progress-bar bg-success" style="width: {{ (event.business_value_impact * 10)|round }}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if event.revenue_impact %}
                                            <div class="col-md-6">
                                                <div class="small">
                                                    <strong>Impacto en Ingresos:</strong> ${{ event.revenue_impact|round(2) }}
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}

                                        {% if event.related_entities %}
                                        <div class="related-entities">
                                            <div class="small fw-semibold mb-1">Entidades Relacionadas:</div>
                                            {% for entity in event.related_entities.split(',') if entity %}
                                            <span class="entity-tag">{{ entity.strip() }}</span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                        {% if event.automation_name %}
                                        <div class="mt-2">
                                            <div class="small">
                                                <i class="fas fa-robot text-primary"></i>
                                                <span class="text-muted">Generado por automatización:</span>
                                                <strong>{{ event.automation_name }}</strong>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="empty-timeline">
                                <i class="fas fa-clock"></i>
                                <h4>No hay eventos en el timeline</h4>
                                <p class="text-muted">
                                    {% if selected_client %}
                                        No se encontraron eventos para {{ selected_client.nombre_empresa }}
                                    {% else %}
                                        No hay eventos registrados en el sistema
                                    {% endif %}
                                </p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newEventModal">
                                    <i class="fas fa-plus"></i> Crear Primer Evento
                                </button>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Load More Button -->
                        {% if timeline_events|length >= 50 %}
                        <div class="text-center mt-4">
                            <button class="btn btn-outline-primary" id="load-more-events">
                                <i class="fas fa-chevron-down"></i> Cargar más eventos
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Event Modal -->
    <div class="modal fade" id="newEventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Evento en Timeline</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newEventForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Cliente *</label>
                                    <select class="form-select" name="client_id" required>
                                        {% if selected_client %}
                                        <option value="{{ selected_client.id }}" selected>{{ selected_client.nombre_empresa }}</option>
                                        {% else %}
                                        <option value="">Seleccionar cliente</option>
                                        {% endif %}
                                        {% for client in clients %}
                                        {% if not selected_client or client.id != selected_client.id %}
                                        <option value="{{ client.id }}">{{ client.nombre_empresa }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Evento *</label>
                                    <select class="form-select" name="event_type" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="communication">Comunicación</option>
                                        <option value="proposal">Propuesta</option>
                                        <option value="meeting">Reunión</option>
                                        <option value="ticket">Ticket</option>
                                        <option value="campaign">Campaña</option>
                                        <option value="automation">Automatización</option>
                                        <option value="other">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Descripción del Evento *</label>
                                    <input type="text" class="form-control" name="description" required placeholder="Ej: Reunión de seguimiento comercial">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Impacto</label>
                                    <select class="form-select" name="impact_score">
                                        <option value="low">Bajo</option>
                                        <option value="medium" selected>Medio</option>
                                        <option value="high">Alto</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fecha y Hora *</label>
                                    <input type="datetime-local" class="form-control" name="event_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Duración (minutos)</label>
                                    <input type="number" class="form-control" name="duration_minutes" min="1" placeholder="30">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Detalles del Evento</label>
                                    <textarea class="form-control" name="event_details" rows="3" placeholder="Describe los detalles del evento..."></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Valor de Negocio (1-10)</label>
                                    <input type="number" class="form-control" name="business_value_impact" min="1" max="10" placeholder="5">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Impacto en Ingresos ($)</label>
                                    <input type="number" class="form-control" name="revenue_impact" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveEvent">
                        <i class="fas fa-save"></i> Guardar Evento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('#client-selector, select[name="client_id"]').select2({
                placeholder: 'Buscar cliente...',
                allowClear: true,
                width: '100%'
            });

            // Client selector change
            $('#client-selector').change(function() {
                const clientId = $(this).val();
                if (clientId) {
                    window.location.href = `/clientes/timeline/${clientId}`;
                } else {
                    window.location.href = '/clientes/timeline';
                }
            });

            // Timeline filtering
            $('#filter-event-type, #filter-period, #filter-impact, #search-timeline').on('change input', function() {
                filterTimeline();
            });

            function filterTimeline() {
                const eventType = $('#filter-event-type').val().toLowerCase();
                const period = parseInt($('#filter-period').val());
                const impact = $('#filter-impact').val().toLowerCase();
                const searchTerm = $('#search-timeline').val().toLowerCase();

                const currentDate = new Date();
                const periodDate = period ? new Date(currentDate.getTime() - (period * 24 * 60 * 60 * 1000)) : null;

                $('.timeline-item').each(function() {
                    const item = $(this);
                    const itemEventType = item.data('event-type') || '';
                    const itemImpact = item.data('impact') || '';
                    const itemDate = new Date(item.data('date'));
                    const itemText = item.text().toLowerCase();

                    let show = true;

                    // Event type filter
                    if (eventType && itemEventType !== eventType) {
                        show = false;
                    }

                    // Period filter
                    if (periodDate && itemDate < periodDate) {
                        show = false;
                    }

                    // Impact filter
                    if (impact && itemImpact !== impact) {
                        show = false;
                    }

                    // Search filter
                    if (searchTerm && !itemText.includes(searchTerm)) {
                        show = false;
                    }

                    if (show) {
                        item.show();
                    } else {
                        item.hide();
                    }
                });

                updateTimelineStats();
            }

            function updateTimelineStats() {
                const visibleItems = $('.timeline-item:visible');
                const eventTypes = {};

                visibleItems.each(function() {
                    const type = $(this).data('event-type') || 'other';
                    eventTypes[type] = (eventTypes[type] || 0) + 1;
                });

                // Update stat cards
                $('.stat-card').each(function() {
                    const card = $(this);
                    const label = card.find('.stat-label').text().toLowerCase();
                    let count = 0;

                    if (label.includes('comunicaciones')) {
                        count = eventTypes['communication'] || 0;
                    } else if (label.includes('propuestas')) {
                        count = eventTypes['proposal'] || 0;
                    } else if (label.includes('reuniones')) {
                        count = eventTypes['meeting'] || 0;
                    } else if (label.includes('tickets')) {
                        count = eventTypes['ticket'] || 0;
                    }

                    card.find('.stat-number').text(count);
                });
            }

            // New event form
            $('#saveEvent').click(function() {
                const formData = $('#newEventForm').serialize();
                
                // Here you would typically send the form data to the server
                console.log('Saving event:', formData);
                
                // For now, just close the modal and show success message
                $('#newEventModal').modal('hide');
                
                $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                  'Evento creado exitosamente en el timeline!' +
                  '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                  '</div>').prependTo('.main-content .p-4');

                // Reset form
                $('#newEventForm')[0].reset();
            });

            // Set current date/time for new events
            const now = new Date();
            const formattedDateTime = now.toISOString().slice(0, 16);
            $('input[name="event_date"]').val(formattedDateTime);

            // Load more events
            $('#load-more-events').click(function() {
                const btn = $(this);
                btn.prop('disabled', true);
                btn.html('<i class="fas fa-spinner fa-spin"></i> Cargando...');

                // Simulate loading
                setTimeout(function() {
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-chevron-down"></i> Cargar más eventos');
                    
                    // Here you would typically load more events via AJAX
                    $('<div class="alert alert-info">No hay más eventos para mostrar</div>')
                        .insertBefore(btn.parent())
                        .delay(3000)
                        .fadeOut();
                }, 1500);
            });

            // Timeline animations on scroll
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animationPlayState = 'running';
                    }
                });
            }, observerOptions);

            $('.timeline-item').each(function() {
                observer.observe(this);
            });
        });
    </script>
</body>
</html>
