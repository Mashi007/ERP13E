# =================================================================
# ğŸ“ Ruta: /app/railway.toml
# ğŸ“„ Nombre: railway.toml
# ğŸ—ï¸ PropÃ³sito: ConfiguraciÃ³n integral Railway para ERP13 Enterprise
# âš¡ Performance: Build y deploy optimizados, health checks integrados
# ğŸ”’ Seguridad: Timeouts seguros, manejo de recursos eficiente
# =================================================================

[build]
# ğŸ”§ COMANDO BUILD OPTIMIZADO
builder = "nixpacks"
buildCommand = """
pip install --no-cache-dir --upgrade pip setuptools wheel &&
pip install --no-cache-dir -r requirements.txt &&
python -c "import flask; print('âœ… Flask instalado correctamente')" &&
python -c "import sqlalchemy; print('âœ… SQLAlchemy instalado correctamente')" &&
python -c "import redis; print('âœ… Redis instalado correctamente')" &&
python -m py_compile main.py &&
echo "âœ… ERP13 Enterprise build completado"
"""

# ğŸ“¦ CONFIGURACIÃ“N PROVIDERS
[[build.providers]]
name = "python"

[deploy]
# ğŸš€ COMANDO START ADAPTADO A TU MAIN.PY (31 RUTAS)
startCommand = """
gunicorn \
  --bind 0.0.0.0:$PORT \
  --workers 2 \
  --worker-class sync \
  --timeout 120 \
  --keep-alive 5 \
  --max-requests 1000 \
  --max-requests-jitter 50 \
  --preload \
  --worker-tmp-dir /dev/shm \
  --log-level info \
  --access-logfile - \
  --error-logfile - \
  --capture-output \
  --enable-stdio-inheritance \
  --pythonpath . \
  wsgi:application
"""

# ğŸ¥ HEALTH CHECK CONFIGURACIÃ“N
healthcheckPath = "/health"
healthcheckTimeout = 10
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3

# â±ï¸ TIMEOUTS OPTIMIZADOS
deployTimeout = 300
startTimeout = 60
stopTimeout = 30

# ğŸ“Š CONFIGURACIÃ“N DE RECURSOS
[deploy.resources]
# ConfiguraciÃ³n conservadora para Railway
memory = "512Mi"
cpu = "0.5"

# ğŸŒ NETWORKING
[deploy.networking]
# Health check endpoint
healthcheck = "/health"

# ğŸ“ CONFIGURACIÃ“N DE ARCHIVOS
[build.watchPaths]
# Paths que triggerean rebuild
include = ["**/*.py", "requirements.txt", "*.toml", "*.yml", "*.yaml"]
ignore = ["**/__pycache__/**", "**/*.pyc", "**/node_modules/**", "**/.git/**"]

# ğŸ”§ VARIABLES DE ENTORNO POR DEFECTO
[env]
# Variables crÃ­ticas que se aplicarÃ¡n si no estÃ¡n definidas
FLASK_APP = "main.py"
FLASK_ENV = "production"
FLASK_DEBUG = "False"
PORT = "8080"
WORKERS = "2"
TIMEOUT = "120"
PYTHONPATH = "."
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"

# ğŸš¦ PRE-DEPLOY HOOKS
[deploy.hooks]
# Verificaciones antes del deploy
beforeDeploy = """
echo "ğŸ” Verificando estructura del proyecto..." &&
ls -la &&
echo "ğŸ” Verificando main.py..." &&
test -f main.py || { echo "âŒ main.py no encontrado"; exit 1; } &&
echo "ğŸ” Verificando requirements.txt..." &&
test -f requirements.txt || { echo "âŒ requirements.txt no encontrado"; exit 1; } &&
echo "ğŸ” Verificando sintaxis Python..." &&
python -m py_compile main.py &&
echo "âœ… Verificaciones pre-deploy completadas"
"""

# ğŸ“ˆ POST-DEPLOY HOOKS
afterDeploy = """
echo "ğŸš€ ERP13 Enterprise desplegado exitosamente" &&
echo "ğŸŒ Servicio disponible en: https://$RAILWAY_PUBLIC_DOMAIN" &&
echo "ğŸ¥ Health check: https://$RAILWAY_PUBLIC_DOMAIN/health" &&
echo "ğŸ“Š Version: $(python -c 'print(__import__(\"main\").__version__ if hasattr(__import__(\"main\"), \"__version__\") else \"1.0.0\")')"
"""

# ğŸ”„ CONFIGURACIÃ“N DE REINICIO
[deploy.restart]
# PolÃ­tica de reinicio en caso de fallo
policy = "on-failure"
maxRetries = 3
delay = "5s"

# ğŸ“‹ LOGGING CONFIGURACIÃ“N
[deploy.logging]
level = "info"
format = "json"
structured = true

# ğŸ¯ CONFIGURACIÃ“N ESPECÃFICA RAILWAY
[railway]
# ConfiguraciÃ³n especÃ­fica para Railway platform
region = "us-east-1"
environment = "production"

# ğŸ“Š MONITOREO Y MÃ‰TRICAS
[deploy.monitoring]
enabled = true
healthcheckInterval = "30s"
healthcheckRetries = 3
healthcheckStartPeriod = "60s"

# ğŸ” SEGURIDAD
[deploy.security]
# ConfiguraciÃ³n de seguridad bÃ¡sica
allowPrivilegedPorts = false
readOnlyRootFilesystem = false  # Flask necesita escribir logs temporales

# ğŸ“ VOLÃšMENES TEMPORALES
[deploy.volumes]
# Directorio temporal para uploads y logs
tmpfs = ["/tmp:size=100M,mode=1777"]

# ğŸš€ CONFIGURACIÃ“N AVANZADA
[build.config]
# ConfiguraciÃ³n adicional del build
nodeVersion = "18"
pythonVersion = "3.12"
pipVersion = "latest"

# ğŸ”§ OPTIMIZACIONES
[deploy.optimizations]
# Optimizaciones para performance
enableCompression = true
enableCaching = true
cacheStaticAssets = true

# ğŸ“Š CONFIGURACIÃ“N DE MÃ‰TRICAS
[deploy.metrics]
enabled = true
path = "/metrics"
port = "$PORT"

# ğŸŒ CONFIGURACIÃ“N MULTI-REGIÃ“N (Pro feature)
[deploy.regions]
primary = "us-east-1"
# replicas = ["eu-west-1", "ap-southeast-1"]  # Comentado para plan gratuito

# ğŸ”„ DATABASE MIGRATIONS (si aplica)
[deploy.migrations]
# Comandos para ejecutar migraciones de BD
beforeStart = """
echo "ğŸ—„ï¸ Verificando conexiÃ³n a base de datos..." &&
python -c "
import os
import psycopg2
try:
    if os.environ.get('DATABASE_URL'):
        conn = psycopg2.connect(os.environ['DATABASE_URL'], connect_timeout=5)
        conn.close()
        print('âœ… Base de datos conectada')
    else:
        print('âš ï¸ DATABASE_URL no configurada')
except Exception as e:
    print(f'âš ï¸ Error BD: {e}')
"
"""

# ğŸ” DEBUGGING (solo para desarrollo)
[build.debug]
enabled = false
verbose = false
