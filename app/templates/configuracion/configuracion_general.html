{% extends "layout.html" %}

{% block title %}Configuraci√≥n General - ERP13 Enterprise{% endblock %}

{% block extra_css %}
<style>
/* ============================================================================
   CONFIGURACI√ìN GENERAL - ERP13 ENTERPRISE
   üìÅ Ruta: /app/templates/configuracion/configuracion_general.html
   üèóÔ∏è Prop√≥sito: Administraci√≥n general completa del sistema ERP
   ‚ö° Performance: CSS Grid + Auto-save + Cache Redis + Real-time validation
   üîí Seguridad: Super-admin roles + Encryption + Audit trail + Backup
============================================================================ */

:root {
    --primary-blue: #3b82f6;
    --success-green: #10b981;
    --warning-orange: #f59e0b;
    --danger-red: #ef4444;
    --info-cyan: #06b6d4;
    --dark-gray: #374151;
    --light-gray: #f8fafc;
    --border-color: #e5e7eb;
    --accent-purple: #8b5cf6;
    --config-bg: #fafbfc;
    --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
    --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
}

body {
    background: linear-gradient(135deg, var(--config-bg) 0%, #f0f2f5 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow-x: hidden;
}

/* ========== LAYOUT PRINCIPAL ========== */
.main-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.hero-section {
    background: var(--gradient-primary);
    color: white;
    padding: 3rem 0;
    box-shadow: var(--shadow-medium);
    position: relative;
    overflow: hidden;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="hexagons" width="30" height="26" patternUnits="userSpaceOnUse"><polygon points="15,2 28,10 28,22 15,30 2,22 2,10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23hexagons)"/></svg>') repeat;
    opacity: 0.3;
}

.hero-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 2rem;
}

.hero-title {
    font-size: 3rem;
    font-weight: 900;
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.hero-icon {
    background: rgba(255, 255, 255, 0.15);
    padding: 1rem;
    border-radius: 20px;
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(255, 255, 255, 0.1);
}

.hero-subtitle {
    font-size: 1.25rem;
    opacity: 0.9;
    margin: 0;
    max-width: 600px;
    line-height: 1.6;
}

.hero-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn {
    padding: 1rem 2rem;
    border-radius: 12px;
    font-weight: 700;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1rem;
    box-shadow: var(--shadow-soft);
}

.btn-light {
    background: white;
    color: var(--primary-blue);
    border: 2px solid transparent;
}

.btn-light:hover {
    background: #f8f9fa;
    transform: translateY(-3px);
    box-shadow: var(--shadow-medium);
}

.btn-outline-light {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
}

.btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-3px);
}

/* ========== √ÅREA DE CONTENIDO ========== */
.content-area {
    flex: 1;
    padding: 3rem 0;
}

/* ========== NAVEGACI√ìN POR TABS ========== */
.config-navigation {
    background: white;
    border-radius: 20px;
    padding: 1rem;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--border-color);
    margin-bottom: 3rem;
    overflow-x: auto;
}

.nav-tabs {
    display: flex;
    gap: 0.5rem;
    margin: 0;
    padding: 0;
    list-style: none;
}

.nav-tab {
    padding: 1.25rem 2rem;
    border: none;
    background: transparent;
    color: var(--dark-gray);
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 16px;
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
}

.nav-tab:hover {
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary-blue);
    transform: translateY(-2px);
}

.nav-tab.active {
    background: var(--primary-blue);
    color: white;
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
}

.nav-tab .tab-icon {
    font-size: 1.25rem;
}

/* ========== CONTENIDO DE TABS ========== */
.tab-content {
    display: none;
    animation: fadeInUp 0.6s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeInUp {
    from { 
        opacity: 0; 
        transform: translateY(30px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.config-section {
    background: white;
    border-radius: 24px;
    padding: 3rem;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--border-color);
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.config-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: var(--gradient-primary);
}

.section-header {
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 2rem;
    margin-bottom: 3rem;
    position: relative;
}

.section-title {
    color: var(--dark-gray);
    font-size: 1.75rem;
    font-weight: 800;
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.section-icon {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-purple) 100%);
    color: white;
    padding: 0.75rem;
    border-radius: 16px;
    font-size: 1.5rem;
    box-shadow: var(--shadow-soft);
}

.section-description {
    color: #6b7280;
    margin: 0;
    font-size: 1.1rem;
    line-height: 1.6;
}

/* ========== GRIDS Y FORMULARIOS ========== */
.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 2.5rem;
}

.form-group {
    margin-bottom: 2rem;
}

.form-label {
    display: block;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 0.75rem;
    font-size: 1rem;
    position: relative;
}

.form-label.required::after {
    content: '*';
    color: var(--danger-red);
    margin-left: 0.25rem;
}

.form-control {
    width: 100%;
    padding: 1rem 1.25rem;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
    transform: translateY(-1px);
}

.form-control:invalid {
    border-color: var(--danger-red);
}

.form-control:valid {
    border-color: var(--success-green);
}

.form-help {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* ========== SWITCHES Y CHECKBOXES ========== */
.switch-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    background: var(--light-gray);
    border-radius: 16px;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
}

.switch-container:hover {
    border-color: var(--primary-blue);
    background: white;
    box-shadow: var(--shadow-soft);
}

.switch-info h6 {
    font-weight: 700;
    color: var(--dark-gray);
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
}

.switch-info p {
    color: #6b7280;
    margin: 0;
    font-size: 0.95rem;
}

.switch {
    position: relative;
    display: inline-block;
    width: 64px;
    height: 36px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #cbd5e1;
    transition: 0.4s;
    border-radius: 36px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.slider:before {
    position: absolute;
    content: "";
    height: 28px;
    width: 28px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

input:checked + .slider {
    background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
}

input:checked + .slider:before {
    transform: translateX(28px);
}

/* ========== CARDS ESPECIALES ========== */
.status-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.status-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.status-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-medium);
}

.status-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
}

.status-card.success::before {
    background: var(--success-green);
}

.status-card.warning::before {
    background: var(--warning-orange);
}

.status-card.info::before {
    background: var(--info-cyan);
}

.status-card.danger::before {
    background: var(--danger-red);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.card-icon {
    font-size: 2rem;
    padding: 1rem;
    border-radius: 16px;
    color: white;
}

.status-card.success .card-icon {
    background: var(--success-green);
}

.status-card.warning .card-icon {
    background: var(--warning-orange);
}

.status-card.info .card-icon {
    background: var(--info-cyan);
}

.status-card.danger .card-icon {
    background: var(--danger-red);
}

.card-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--dark-gray);
    margin: 0;
}

.card-value {
    font-size: 2rem;
    font-weight: 900;
    margin: 1rem 0;
}

.card-description {
    color: #6b7280;
    font-size: 0.95rem;
    margin: 0;
}

/* ========== BOTONES ESPECIALES ========== */
.btn-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 2rem;
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
    border: 2px solid transparent;
}

.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
    color: white;
    border: 2px solid transparent;
}

.btn-success:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
}

.btn-warning {
    background: linear-gradient(135deg, var(--warning-orange) 0%, #d97706 100%);
    color: white;
    border: 2px solid transparent;
}

.btn-warning:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger-red) 0%, #dc2626 100%);
    color: white;
    border: 2px solid transparent;
}

.btn-danger:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
}

.btn-outline-primary {
    background: transparent;
    color: var(--primary-blue);
    border: 2px solid var(--primary-blue);
}

.btn-outline-primary:hover {
    background: var(--primary-blue);
    color: white;
    transform: translateY(-3px);
}

/* ========== MODALES Y OVERLAYS ========== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-overlay.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 24px;
    padding: 3rem;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* ========== INDICADORES Y NOTIFICACIONES ========== */
.notification {
    position: fixed;
    top: 24px;
    right: 24px;
    padding: 1.25rem 2rem;
    border-radius: 16px;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    transform: translateX(100%);
    transition: all 0.4s ease;
    z-index: 1001;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    max-width: 400px;
}

.notification.show {
    transform: translateX(0);
}

.notification.success {
    background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
}

.notification.error {
    background: linear-gradient(135deg, var(--danger-red) 0%, #dc2626 100%);
}

.notification.warning {
    background: linear-gradient(135deg, var(--warning-orange) 0%, #d97706 100%);
}

.notification.info {
    background: linear-gradient(135deg, var(--info-cyan) 0%, #0891b2 100%);
}

/* ========== RESPONSIVE DESIGN ========== */
@media (max-width: 1200px) {
    .config-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
    }
}

@media (max-width: 1024px) {
    .hero-content {
        flex-direction: column;
        text-align: center;
        gap: 2rem;
    }

    .hero-actions {
        width: 100%;
        justify-content: center;
    }

    .config-grid {
        grid-template-columns: 1fr;
    }

    .status-cards {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    .hero-section {
        padding: 2rem 0;
    }

    .hero-title {
        font-size: 2rem;
        flex-direction: column;
        gap: 1rem;
    }

    .hero-subtitle {
        font-size: 1rem;
    }

    .content-area {
        padding: 2rem 0;
    }

    .config-section {
        padding: 2rem 1.5rem;
        margin-bottom: 1.5rem;
    }

    .nav-tabs {
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .nav-tab {
        padding: 1rem 1.5rem;
        font-size: 0.9rem;
    }

    .btn-group {
        flex-direction: column;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .hero-section {
        padding: 1.5rem 0;
    }

    .hero-title {
        font-size: 1.75rem;
    }

    .config-section {
        padding: 1.5rem 1rem;
    }

    .section-title {
        font-size: 1.5rem;
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
    }

    .modal-content {
        padding: 2rem 1.5rem;
        width: 95%;
    }

    .notification {
        right: 12px;
        left: 12px;
        transform: translateY(-100%);
        max-width: none;
    }

    .notification.show {
        transform: translateY(0);
    }
}

/* ========== ANIMACIONES Y EFECTOS ========== */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.loading {
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
    20%, 40%, 60%, 80% { transform: translateX(2px); }
}

.error-shake {
    animation: shake 0.5s ease-in-out;
}

/* ========== UTILIDADES ========== */
.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

.mb-0 { margin-bottom: 0; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }
.mb-4 { margin-bottom: 2rem; }

.mt-0 { margin-top: 0; }
.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mt-4 { margin-top: 2rem; }

.d-none { display: none; }
.d-block { display: block; }
.d-flex { display: flex; }
.d-grid { display: grid; }

.w-100 { width: 100%; }
.h-100 { height: 100%; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- ========== HERO SECTION ========== -->
    <div class="hero-section">
        <div class="container">
            <div class="hero-content">
                <div>
                    <h1 class="hero-title">
                        <div class="hero-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        Configuraci√≥n General
                    </h1>
                    <p class="hero-subtitle">
                        Centro de control principal del sistema ERP13 Enterprise. 
                        Gestiona todos los aspectos fundamentales de tu organizaci√≥n.
                    </p>
                </div>
                <div class="hero-actions">
                    <button class="btn btn-light" onclick="exportSystemConfig()">
                        <i class="fas fa-download"></i>
                        Exportar Configuraci√≥n
                    </button>
                    <button class="btn btn-outline-light" onclick="importSystemConfig()">
                        <i class="fas fa-upload"></i>
                        Importar Configuraci√≥n
                    </button>
                    <button class="btn btn-outline-light" onclick="resetToDefaults()">
                        <i class="fas fa-undo"></i>
                        Restaurar Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== √ÅREA DE CONTENIDO ========== -->
    <div class="content-area">
        <div class="container">
            <!-- ========== NAVEGACI√ìN POR TABS ========== -->
            <div class="config-navigation">
                <ul class="nav-tabs">
                    <li class="nav-tab active" onclick="switchTab('empresa')" data-tab="empresa">
                        <i class="fas fa-building tab-icon"></i>
                        <span>Empresa</span>
                    </li>
                    <li class="nav-tab" onclick="switchTab('sistema')" data-tab="sistema">
                        <i class="fas fa-server tab-icon"></i>
                        <span>Sistema</span>
                    </li>
                    <li class="nav-tab" onclick="switchTab('seguridad')" data-tab="seguridad">
                        <i class="fas fa-shield-alt tab-icon"></i>
                        <span>Seguridad</span>
                    </li>
                    <li class="nav-tab" onclick="switchTab('notificaciones')" data-tab="notificaciones">
                        <i class="fas fa-bell tab-icon"></i>
                        <span>Notificaciones</span>
                    </li>
                    <li class="nav-tab" onclick="switchTab('integraciones')" data-tab="integraciones">
                        <i class="fas fa-plug tab-icon"></i>
                        <span>Integraciones</span>
                    </li>
                    <li class="nav-tab" onclick="switchTab('mantenimiento')" data-tab="mantenimiento">
                        <i class="fas fa-tools tab-icon"></i>
                        <span>Mantenimiento</span>
                    </li>
                </ul>
            </div>

            <!-- ========== TAB: EMPRESA ========== -->
            <div id="tab-empresa" class="tab-content active">
                <!-- Estado del Sistema -->
                <div class="status-cards">
                    <div class="status-card success">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3 class="card-title">Sistema Operativo</h3>
                        </div>
                        <div class="card-value" style="color: var(--success-green);">99.8%</div>
                        <p class="card-description">Uptime √∫ltimos 30 d√≠as</p>
                    </div>

                    <div class="status-card info">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 class="card-title">Usuarios Activos</h3>
                        </div>
                        <div class="card-value" style="color: var(--info-cyan);">24</div>
                        <p class="card-description">Conectados en las √∫ltimas 24h</p>
                    </div>

                    <div class="status-card warning">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <h3 class="card-title">Almacenamiento</h3>
                        </div>
                        <div class="card-value" style="color: var(--warning-orange);">78%</div>
                        <p class="card-description">Uso del espacio disponible</p>
                    </div>

                    <div class="status-card success">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3 class="card-title">Seguridad</h3>
                        </div>
                        <div class="card-value" style="color: var(--success-green);">A+</div>
                        <p class="card-description">Nivel de seguridad actual</p>
                    </div>
                </div>

                <!-- Informaci√≥n de la Empresa -->
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            Informaci√≥n de la Empresa
                        </h2>
                        <p class="section-description">
                            Datos fundamentales de tu organizaci√≥n que se utilizan en todo el sistema
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label required" for="company_name">Nombre de la Empresa</label>
                            <input type="text" id="company_name" class="form-control" 
                                   data-module="general" data-key="company_name"
                                   placeholder="Tu Empresa S.L." required>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Nombre legal completo de la empresa
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required" for="company_tax_id">CIF/NIF</label>
                            <input type="text" id="company_tax_id" class="form-control" 
                                   data-module="general" data-key="company_tax_id"
                                   placeholder="B12345678" required>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                C√≥digo de identificaci√≥n fiscal
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="company_address">Direcci√≥n Completa</label>
                            <textarea id="company_address" class="form-control" rows="4"
                                      data-module="general" data-key="company_address"
                                      placeholder="Calle Principal, 123&#10;28001 Madrid&#10;Espa√±a"></textarea>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Direcci√≥n principal de la empresa
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="company_phone">Tel√©fono Principal</label>
                            <input type="tel" id="company_phone" class="form-control" 
                                   data-module="general" data-key="company_phone"
                                   placeholder="+34 912 345 678">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Tel√©fono de contacto principal
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required" for="company_email">Email Corporativo</label>
                            <input type="email" id="company_email" class="form-control" 
                                   data-module="general" data-key="company_email"
                                   placeholder="info@tuempresa.com" required>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Email principal para comunicaciones
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="company_website">Sitio Web</label>
                            <input type="url" id="company_website" class="form-control" 
                                   data-module="general" data-key="company_website"
                                   placeholder="https://www.tuempresa.com">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                URL del sitio web corporativo
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="company_sector">Sector de Actividad</label>
                            <select id="company_sector" class="form-control" data-module="general" data-key="company_sector">
                                <option value="">Seleccionar sector...</option>
                                <option value="technology">Tecnolog√≠a</option>
                                <option value="consulting">Consultor√≠a</option>
                                <option value="manufacturing">Manufactura</option>
                                <option value="retail">Comercio al por menor</option>
                                <option value="healthcare">Salud</option>
                                <option value="education">Educaci√≥n</option>
                                <option value="finance">Finanzas</option>
                                <option value="construction">Construcci√≥n</option>
                                <option value="hospitality">Hosteler√≠a</option>
                                <option value="other">Otro</option>
                            </select>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Sector principal de actividad
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="company_size">Tama√±o de la Empresa</label>
                            <select id="company_size" class="form-control" data-module="general" data-key="company_size">
                                <option value="">Seleccionar tama√±o...</option>
                                <option value="micro">Microempresa (1-10 empleados)</option>
                                <option value="small">Peque√±a (11-50 empleados)</option>
                                <option value="medium">Mediana (51-250 empleados)</option>
                                <option value="large">Grande (250+ empleados)</option>
                            </select>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Clasificaci√≥n por n√∫mero de empleados
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logo y Branding -->
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            Logo y Branding
                        </h2>
                        <p class="section-description">
                            Personaliza la identidad visual de tu empresa en el sistema
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="company_logo">Logo de la Empresa</label>
                            <input type="file" id="company_logo" class="form-control" 
                                   data-module="general" data-key="company_logo"
                                   accept="image/*">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Formatos: PNG, JPG, SVG (m√°x. 2MB)
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="brand_color_primary">Color Primario</label>
                            <input type="color" id="brand_color_primary" class="form-control" 
                                   data-module="general" data-key="brand_color_primary"
                                   value="#3b82f6">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Color principal de la marca
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="brand_color_secondary">Color Secundario</label>
                            <input type="color" id="brand_color_secondary" class="form-control" 
                                   data-module="general" data-key="brand_color_secondary"
                                   value="#10b981">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Color secundario de la marca
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="brand_font">Fuente Corporativa</label>
                            <select id="brand_font" class="form-control" data-module="general" data-key="brand_font">
                                <option value="system">Fuente del Sistema</option>
                                <option value="inter">Inter</option>
                                <option value="roboto">Roboto</option>
                                <option value="open-sans">Open Sans</option>
                                <option value="montserrat">Montserrat</option>
                                <option value="lato">Lato</option>
                            </select>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Tipograf√≠a para la interfaz
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== TAB: SISTEMA ========== -->
            <div id="tab-sistema" class="tab-content">
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            Configuraci√≥n del Sistema
                        </h2>
                        <p class="section-description">
                            Par√°metros t√©cnicos y de funcionamiento del ERP
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="system_timezone">Zona Horaria</label>
                            <select id="system_timezone" class="form-control" data-module="system" data-key="timezone">
                                <option value="Europe/Madrid" selected>Europa/Madrid (CET)</option>
                                <option value="Europe/London">Europa/Londres (GMT)</option>
                                <option value="America/New_York">Am√©rica/Nueva York (EST)</option>
                                <option value="America/Los_Angeles">Am√©rica/Los √Ångeles (PST)</option>
                                <option value="Asia/Tokyo">Asia/Tokio (JST)</option>
                                <option value="UTC">UTC</option>
                            </select>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Zona horaria principal del sistema
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="system_language">Idioma del Sistema</label>
                            <select id="system_language" class="form-control" data-module="system" data-key="language">
                                <option value="es" selected>Espa√±ol</option>
                                <option value="en">English</option>
                                <option value="fr">Fran√ßais</option>
                                <option value="de">Deutsch</option>
                                <option value="it">Italiano</option>
                                <option value="pt">Portugu√™s</option>
                            </select>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Idioma predeterminado de la interfaz
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="system_currency">Moneda Principal</label>
                            <select id="system_currency" class="form-control" data-module="system" data-key="currency">
                                <option value="EUR" selected>EUR - Euro</option>
                                <option value="USD">USD - D√≥lar Americano</option>
                                <option value="GBP">GBP - Libra Esterlina</option>
                                <option value="CHF">CHF - Franco Suizo</option>
                                <option value="JPY">JPY - Yen Japon√©s</option>
                            </select>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Moneda por defecto para transacciones
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="date_format">Formato de Fecha</label>
                            <select id="date_format" class="form-control" data-module="system" data-key="date_format">
                                <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option>
                                <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                <option value="dd-mm-yyyy">DD-MM-YYYY</option>
                            </select>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Formato de visualizaci√≥n de fechas
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="number_format">Formato Num√©rico</label>
                            <select id="number_format" class="form-control" data-module="system" data-key="number_format">
                                <option value="european" selected>1.234,56 (Europeo)</option>
                                <option value="american">1,234.56 (Americano)</option>
                                <option value="space">1 234,56 (Espacios)</option>
                                <option value="apostrophe">1'234.56 (Ap√≥strofe)</option>
                            </select>
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Formato de visualizaci√≥n de n√∫meros
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="session_timeout">Timeout de Sesi√≥n (minutos)</label>
                            <input type="number" id="session_timeout" class="form-control" 
                                   data-module="system" data-key="session_timeout"
                                   value="60" min="15" max="480" placeholder="60">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Tiempo de inactividad antes de cerrar sesi√≥n
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuraciones Avanzadas -->
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            Configuraciones Avanzadas
                        </h2>
                        <p class="section-description">
                            Opciones t√©cnicas para administradores del sistema
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Modo Debug</h6>
                                <p>Habilita logs detallados para desarrollo</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="system" data-key="debug_mode">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Cache del Sistema</h6>
                                <p>Mejora el rendimiento almacenando datos frecuentes</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="system" data-key="cache_enabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Compresi√≥n de Datos</h6>
                                <p>Reduce el tama√±o de las transferencias</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="system" data-key="compression_enabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Auto-optimizaci√≥n</h6>
                                <p>Optimiza autom√°ticamente la base de datos</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="system" data-key="auto_optimize" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Telemetr√≠a</h6>
                                <p>Env√≠a datos an√≥nimos para mejorar el producto</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="system" data-key="telemetry_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Actualizaciones Autom√°ticas</h6>
                                <p>Instala autom√°ticamente parches de seguridad</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="system" data-key="auto_updates" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== TAB: SEGURIDAD ========== -->
            <div id="tab-seguridad" class="tab-content">
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            Pol√≠ticas de Seguridad
                        </h2>
                        <p class="section-description">
                            Configuraci√≥n avanzada de seguridad y acceso al sistema
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="password_min_length">Longitud M√≠nima de Contrase√±a</label>
                            <input type="number" id="password_min_length" class="form-control" 
                                   data-module="security" data-key="password_min_length"
                                   value="8" min="6" max="32" placeholder="8">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                N√∫mero m√≠nimo de caracteres para contrase√±as
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="max_login_attempts">Intentos M√°ximos de Login</label>
                            <input type="number" id="max_login_attempts" class="form-control" 
                                   data-module="security" data-key="max_login_attempts"
                                   value="5" min="3" max="10" placeholder="5">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Intentos fallidos antes de bloquear cuenta
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="lockout_duration">Duraci√≥n de Bloqueo (minutos)</label>
                            <input type="number" id="lockout_duration" class="form-control" 
                                   data-module="security" data-key="lockout_duration"
                                   value="15" min="5" max="60" placeholder="15">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Tiempo de bloqueo tras intentos fallidos
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="password_expiry_days">Caducidad de Contrase√±a (d√≠as)</label>
                            <input type="number" id="password_expiry_days" class="form-control" 
                                   data-module="security" data-key="password_expiry_days"
                                   value="90" min="30" max="365" placeholder="90">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                D√≠as hasta que expire la contrase√±a
                            </div>
                        </div>
                    </div>

                    <div class="config-grid mt-4">
                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Autenticaci√≥n de Dos Factores</h6>
                                <p>Requiere un segundo factor para el acceso</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="security" data-key="two_factor_auth" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Contrase√±as Complejas</h6>
                                <p>Requiere may√∫sculas, n√∫meros y s√≠mbolos</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="security" data-key="complex_passwords" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Logs de Auditor√≠a</h6>
                                <p>Registra todas las acciones del sistema</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="security" data-key="audit_logs" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Encriptaci√≥n de Base de Datos</h6>
                                <p>Encripta datos sensibles en la base de datos</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="security" data-key="db_encryption" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Firewall de Aplicaci√≥n</h6>
                                <p>Protecci√≥n contra ataques web comunes</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="security" data-key="app_firewall" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Restricci√≥n de IP</h6>
                                <p>Limita acceso a IPs espec√≠ficas</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="security" data-key="ip_restriction">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Lista de IPs Permitidas -->
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-network-wired"></i>
                            </div>
                            Control de Acceso por IP
                        </h2>
                        <p class="section-description">
                            Gestiona las direcciones IP que pueden acceder al sistema
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="allowed_ips">Direcciones IP Permitidas</label>
                        <textarea id="allowed_ips" class="form-control" rows="5"
                                  data-module="security" data-key="allowed_ips"
                                  placeholder="192.168.1.0/24&#10;10.0.0.0/8&#10;172.16.0.0/16&#10;203.0.113.10&#10;198.51.100.20"></textarea>
                        <div class="form-help">
                            <i class="fas fa-info-circle"></i>
                            Una IP o rango CIDR por l√≠nea. Dejar vac√≠o para permitir todas las IPs.
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="validateIPs()">
                            <i class="fas fa-check"></i>
                            Validar IPs
                        </button>
                        <button class="btn btn-outline-primary" onclick="addCurrentIP()">
                            <i class="fas fa-plus"></i>
                            A√±adir IP Actual
                        </button>
                    </div>
                </div>
            </div>

            <!-- ========== TAB: NOTIFICACIONES ========== -->
            <div id="tab-notificaciones" class="tab-content">
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            Sistema de Notificaciones
                        </h2>
                        <p class="section-description">
                            Configura c√≥mo y cu√°ndo el sistema env√≠a notificaciones
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Notificaciones por Email</h6>
                                <p>Enviar notificaciones por correo electr√≥nico</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="notifications" data-key="email_enabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Notificaciones Push</h6>
                                <p>Notificaciones en tiempo real en el navegador</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="notifications" data-key="push_enabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Notificaciones SMS</h6>
                                <p>Enviar notificaciones por mensaje de texto</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="notifications" data-key="sms_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Notificaciones de Slack</h6>
                                <p>Integraci√≥n con canales de Slack</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="notifications" data-key="slack_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Resumen Diario</h6>
                                <p>Enviar resumen diario de actividades</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="notifications" data-key="daily_summary" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Alertas de Seguridad</h6>
                                <p>Notificaciones inmediatas sobre seguridad</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="notifications" data-key="security_alerts" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Configuraci√≥n de Email -->
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            Configuraci√≥n de Email
                        </h2>
                        <p class="section-description">
                            Par√°metros del servidor SMTP para env√≠o de emails
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="smtp_server">Servidor SMTP</label>
                            <input type="text" id="smtp_server" class="form-control" 
                                   data-module="notifications" data-key="smtp_server"
                                   placeholder="smtp.gmail.com">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Direcci√≥n del servidor SMTP
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="smtp_port">Puerto SMTP</label>
                            <input type="number" id="smtp_port" class="form-control" 
                                   data-module="notifications" data-key="smtp_port"
                                   value="587" placeholder="587">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Puerto del servidor SMTP (587 para TLS, 465 para SSL)
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="smtp_username">Usuario SMTP</label>
                            <input type="text" id="smtp_username" class="form-control" 
                                   data-module="notifications" data-key="smtp_username"
                                   placeholder="tu-email@empresa.com">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Usuario para autenticaci√≥n SMTP
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="smtp_password">Contrase√±a SMTP</label>
                            <input type="password" id="smtp_password" class="form-control" 
                                   data-module="notifications" data-key="smtp_password"
                                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Contrase√±a para autenticaci√≥n SMTP
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="smtp_from_name">Nombre del Remitente</label>
                            <input type="text" id="smtp_from_name" class="form-control" 
                                   data-module="notifications" data-key="smtp_from_name"
                                   placeholder="ERP13 Enterprise">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Nombre que aparecer√° como remitente
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="smtp_from_email">Email del Remitente</label>
                            <input type="email" id="smtp_from_email" class="form-control" 
                                   data-module="notifications" data-key="smtp_from_email"
                                   placeholder="noreply@tuempresa.com">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Email que aparecer√° como remitente
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="testEmailConfig()">
                            <i class="fas fa-paper-plane"></i>
                            Enviar Email de Prueba
                        </button>
                        <button class="btn btn-outline-primary" onclick="validateEmailConfig()">
                            <i class="fas fa-check"></i>
                            Validar Configuraci√≥n
                        </button>
                    </div>
                </div>
            </div>

            <!-- ========== TAB: INTEGRACIONES ========== -->
            <div id="tab-integraciones" class="tab-content">
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-plug"></i>
                            </div>
                            Integraciones Externas
                        </h2>
                        <p class="section-description">
                            Conecta el ERP con servicios y aplicaciones externas
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Google Workspace</h6>
                                <p>Integraci√≥n con Gmail, Calendar y Drive</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="integrations" data-key="google_workspace" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Microsoft 365</h6>
                                <p>Integraci√≥n con Outlook, Teams y OneDrive</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="integrations" data-key="microsoft_365">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Slack</h6>
                                <p>Notificaciones y comandos desde Slack</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="integrations" data-key="slack_integration">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Zapier</h6>
                                <p>Automatizaciones con miles de aplicaciones</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="integrations" data-key="zapier_integration">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>WhatsApp Business</h6>
                                <p>Comunicaci√≥n directa con clientes</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="integrations" data-key="whatsapp_business" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Telegram Bot</h6>
                                <p>Notificaciones y comandos por Telegram</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="integrations" data-key="telegram_bot">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- APIs de Terceros -->
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            APIs de Terceros
                        </h2>
                        <p class="section-description">
                            Configura las claves de API para servicios externos
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label" for="openai_api_key">OpenAI API Key</label>
                            <input type="password" id="openai_api_key" class="form-control" 
                                   data-module="integrations" data-key="openai_api_key"
                                   placeholder="sk-...">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Clave API para funciones de IA
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="anthropic_api_key">Anthropic API Key</label>
                            <input type="password" id="anthropic_api_key" class="form-control" 
                                   data-module="integrations" data-key="anthropic_api_key"
                                   placeholder="sk-ant-...">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Clave API para Claude AI
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="google_maps_api_key">Google Maps API Key</label>
                            <input type="password" id="google_maps_api_key" class="form-control" 
                                   data-module="integrations" data-key="google_maps_api_key"
                                   placeholder="AIza...">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Clave API para funciones de mapas
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="stripe_public_key">Stripe Public Key</label>
                            <input type="text" id="stripe_public_key" class="form-control" 
                                   data-module="integrations" data-key="stripe_public_key"
                                   placeholder="pk_live_...">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Clave p√∫blica de Stripe para pagos
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="stripe_secret_key">Stripe Secret Key</label>
                            <input type="password" id="stripe_secret_key" class="form-control" 
                                   data-module="integrations" data-key="stripe_secret_key"
                                   placeholder="sk_live_...">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                Clave secreta de Stripe para pagos
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="twilio_account_sid">Twilio Account SID</label>
                            <input type="text" id="twilio_account_sid" class="form-control" 
                                   data-module="integrations" data-key="twilio_account_sid"
                                   placeholder="AC...">
                            <div class="form-help">
                                <i class="fas fa-info-circle"></i>
                                SID de cuenta para SMS y llamadas
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== TAB: MANTENIMIENTO ========== -->
            <div id="tab-mantenimiento" class="tab-content">
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-tools"></i>
                            </div>
                            Herramientas de Mantenimiento
                        </h2>
                        <p class="section-description">
                            Utilidades para el mantenimiento y optimizaci√≥n del sistema
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Backup Autom√°tico</h6>
                                <p>Copia de seguridad programada diariamente</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="maintenance" data-key="auto_backup" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Limpieza de Logs</h6>
                                <p>Elimina autom√°ticamente logs antiguos</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="maintenance" data-key="log_cleanup" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Optimizaci√≥n de DB</h6>
                                <p>Optimiza la base de datos semanalmente</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="maintenance" data-key="db_optimize" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="switch-container">
                            <div class="switch-info">
                                <h6>Modo Mantenimiento</h6>
                                <p>Activa p√°gina de mantenimiento para usuarios</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" data-module="maintenance" data-key="maintenance_mode">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="btn-group mt-4">
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i class="fas fa-download"></i>
                            Crear Backup Ahora
                        </button>
                        <button class="btn btn-warning" onclick="optimizeDatabase()">
                            <i class="fas fa-database"></i>
                            Optimizar Base de Datos
                        </button>
                        <button class="btn btn-info" onclick="clearCache()">
                            <i class="fas fa-broom"></i>
                            Limpiar Cache
                        </button>
                        <button class="btn btn-danger" onclick="clearAllLogs()">
                            <i class="fas fa-trash"></i>
                            Limpiar Todos los Logs
                        </button>
                    </div>
                </div>

                <!-- Informaci√≥n del Sistema -->
                <div class="config-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            Informaci√≥n del Sistema
                        </h2>
                        <p class="section-description">
                            Datos t√©cnicos y estad√≠sticas del sistema
                        </p>
                    </div>

                    <div class="config-grid">
                        <div class="form-group">
                            <label class="form-label">Versi√≥n del ERP</label>
                            <input type="text" class="form-control" value="ERP13 Enterprise v3.2.1" readonly>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Versi√≥n de Python</label>
                            <input type="text" class="form-control" value="Python 3.11.5" readonly>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Base de Datos</label>
                            <input type="text" class="form-control" value="PostgreSQL 15.4" readonly>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Servidor Web</label>
                            <input type="text" class="form-control" value="Gunicorn 21.2.0" readonly>
                        </div>

                        <div class="form-group">
                            <label class="form-label">√öltima Actualizaci√≥n</label>
                            <input type="text" class="form-control" value="19/09/2025 - 14:30" readonly>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tiempo de Actividad</label>
                            <input type="text" class="form-control" value="127 d√≠as, 14 horas" readonly>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="checkForUpdates()">
                            <i class="fas fa-sync"></i>
                            Buscar Actualizaciones
                        </button>
                        <button class="btn btn-outline-primary" onclick="generateSystemReport()">
                            <i class="fas fa-file-medical"></i>
                            Generar Reporte del Sistema
                        </button>
                        <button class="btn btn-outline-primary" onclick="downloadSystemLogs()">
                            <i class="fas fa-download"></i>
                            Descargar Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== MODALES ========== -->
<!-- Modal de Confirmaci√≥n -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="confirmTitle">Confirmar Acci√≥n</h3>
        <p id="confirmMessage">¬øEst√°s seguro de que deseas realizar esta acci√≥n?</p>
        <div class="btn-group">
            <button class="btn btn-danger" id="confirmButton">Confirmar</button>
            <button class="btn btn-outline-primary" onclick="closeModal('confirmModal')">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal de Progreso -->
<div id="progressModal" class="modal-overlay">
    <div class="modal-content text-center">
        <h3 id="progressTitle">Procesando...</h3>
        <div style="width: 100%; background: #e5e7eb; border-radius: 10px; margin: 2rem 0;">
            <div id="progressBar" style="width: 0%; height: 20px; background: var(--primary-blue); border-radius: 10px; transition: width 0.3s ease;"></div>
        </div>
        <p id="progressMessage">Por favor, espera mientras procesamos tu solicitud...</p>
    </div>
</div>

<!-- ========== NOTIFICACI√ìN ========== -->
<div id="notification" class="notification">
    <i class="fas fa-check"></i>
    <span id="notificationText">Configuraci√≥n guardada exitosamente</span>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ============================================================================
   CONFIGURACI√ìN GENERAL - JAVASCRIPT
   üèóÔ∏è Prop√≥sito: Gesti√≥n completa de configuraci√≥n + Auto-save + Validaci√≥n
   ‚ö° Performance: Debounced saving + LocalStorage + Real-time updates
   üîí Seguridad: CSRF tokens + Input validation + API encryption
============================================================================ */

// Estado global de la aplicaci√≥n
let currentTab = 'empresa';
let isConfigDirty = false;
let saveTimeout = null;
let systemInfo = {};

// ========== INICIALIZACI√ìN ========== 
document.addEventListener('DOMContentLoaded', function() {
    initializeConfiguration();
    setupEventListeners();
    loadConfigurationData();
    loadSystemInfo();
    restoreActiveTab();
});

// ========== GESTI√ìN DE TABS ========== 
function switchTab(tabName) {
    // Ocultar todos los tabs
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    const tabButtons = document.querySelectorAll('.nav-tab');
    tabButtons.forEach(button => button.classList.remove('active'));
    
    // Mostrar el tab seleccionado
    document.getElementById(`tab-${tabName}`).classList.add('active');
    const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }
    
    // Actualizar estado
    currentTab = tabName;
    localStorage.setItem('activeConfigTab', tabName);
    
    // Cargar datos espec√≠ficos del tab si es necesario
    loadTabSpecificData(tabName);
}

function restoreActiveTab() {
    const savedTab = localStorage.getItem('activeConfigTab') || 'empresa';
    switchTab(savedTab);
}

function loadTabSpecificData(tabName) {
    switch(tabName) {
        case 'sistema':
            loadSystemMetrics();
            break;
        case 'seguridad':
            loadSecurityStatus();
            break;
        case 'mantenimiento':
            loadMaintenanceInfo();
            break;
        default:
            break;
    }
}

// ========== CONFIGURACI√ìN E INICIALIZACI√ìN ========== 
function initializeConfiguration() {
    // Configurar auto-save para todos los campos
    const configFields = document.querySelectorAll('[data-module][data-key]');
    configFields.forEach(field => {
        if (field.type === 'checkbox') {
            field.addEventListener('change', debounceAutoSave);
        } else {
            field.addEventListener('input', debounceAutoSave);
            field.addEventListener('change', debounceAutoSave);
        }
    });
    
    // Configurar validaci√≥n en tiempo real
    setupRealTimeValidation();
}

function setupEventListeners() {
    // Escape para cerrar modales
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
    
    // Shortcuts de teclado
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    forceSaveConfiguration();
                    break;
                case 'e':
                    e.preventDefault();
                    exportSystemConfig();
                    break;
                case 'r':
                    e.preventDefault();
                    if (e.shiftKey) {
                        resetToDefaults();
                    }
                    break;
            }
        }
    });
}

function setupRealTimeValidation() {
    // Validaci√≥n de email
    const emailFields = document.querySelectorAll('input[type="email"]');
    emailFields.forEach(field => {
        field.addEventListener('blur', validateEmail);
    });
    
    // Validaci√≥n de URLs
    const urlFields = document.querySelectorAll('input[type="url"]');
    urlFields.forEach(field => {
        field.addEventListener('blur', validateURL);
    });
    
    // Validaci√≥n de n√∫meros
    const numberFields = document.querySelectorAll('input[type="number"]');
    numberFields.forEach(field => {
        field.addEventListener('blur', validateNumber);
    });
}

// ========== AUTO-SAVE FUNCTIONALITY ========== 
function debounceAutoSave() {
    isConfigDirty = true;
    
    // Limpiar timeout anterior
    if (saveTimeout) {
        clearTimeout(saveTimeout);
    }
    
    // Programar guardado en 2 segundos
    saveTimeout = setTimeout(() => {
        autoSaveConfiguration();
    }, 2000);
    
    // Mostrar indicador visual
    showSaveIndicator('saving');
}

function autoSaveConfiguration() {
    const formData = collectFormData();
    
    fetch('/api/configuration/general/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Configuraci√≥n guardada autom√°ticamente');
            isConfigDirty = false;
        } else {
            showNotification('error', 'Error al guardar: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving configuration:', error);
        showNotification('error', 'Error de conexi√≥n al guardar');
    });
}

function forceSaveConfiguration() {
    if (saveTimeout) {
        clearTimeout(saveTimeout);
    }
    autoSaveConfiguration();
}

function collectFormData() {
    const formData = {};
    const configFields = document.querySelectorAll('[data-module][data-key]');
    
    configFields.forEach(field => {
        const module = field.getAttribute('data-module');
        const key = field.getAttribute('data-key');
        let value = field.value;
        
        // Manejar diferentes tipos de campos
        if (field.type === 'checkbox') {
            value = field.checked;
        } else if (field.type === 'number') {
            value = parseFloat(value) || 0;
        } else if (field.type === 'file') {
            // Para archivos, manejar por separado
            if (field.files.length > 0) {
                handleFileUpload(field, module, key);
                return;
            } else {
                return; // Skip si no hay archivo
            }
        }
        
        if (!formData[module]) {
            formData[module] = {};
        }
        formData[module][key] = value;
    });
    
    return formData;
}

// ========== CARGA DE DATOS ========== 
function loadConfigurationData() {
    showProgressModal('Cargando configuraci√≥n...', 'Obteniendo datos del servidor');
    
    fetch('/api/configuration/general/load', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateConfigurationFields(data.configuration);
            showNotification('success', 'Configuraci√≥n cargada exitosamente');
        } else {
            showNotification('error', 'Error al cargar configuraci√≥n');
        }
    })
    .catch(error => {
        console.error('Error loading configuration:', error);
        showNotification('error', 'Error de conexi√≥n al cargar datos');
    })
    .finally(() => {
        closeModal('progressModal');
    });
}

function populateConfigurationFields(config) {
    Object.keys(config).forEach(module => {
        Object.keys(config[module]).forEach(key => {
            const field = document.querySelector(`[data-module="${module}"][data-key="${key}"]`);
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = config[module][key];
                } else {
                    field.value = config[module][key];
                }
                
                // Trigger events para actualizar UI
                field.dispatchEvent(new Event(field.type === 'checkbox' ? 'change' : 'input'));
            }
        });
    });
}

function loadSystemInfo() {
    fetch('/api/system/info', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            systemInfo = data.info;
            updateSystemInfoDisplay();
        }
    })
    .catch(error => {
        console.error('Error loading system info:', error);
    });
}

// ========== FUNCIONES DE EXPORTACI√ìN/IMPORTACI√ìN ========== 
function exportSystemConfig() {
    showProgressModal('Exportando configuraci√≥n...', 'Generando archivo de configuraci√≥n');
    
    fetch('/api/configuration/export', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Error en la exportaci√≥n');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `erp13_config_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification('success', 'Configuraci√≥n exportada exitosamente');
    })
    .catch(error => {
        console.error('Error exporting configuration:', error);
        showNotification('error', 'Error al exportar configuraci√≥n');
    })
    .finally(() => {
        closeModal('progressModal');
    });
}

function importSystemConfig() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    confirmImportConfig(config);
                } catch (error) {
                    showNotification('error', 'Archivo de configuraci√≥n inv√°lido');
                }
            };
            reader.readAsText(file);
        }
    };
    input.click();
}

function confirmImportConfig(config) {
    showConfirmModal(
        'Importar Configuraci√≥n',
        '¬øEst√°s seguro de que deseas importar esta configuraci√≥n? Esto sobrescribir√° la configuraci√≥n actual.',
        () => {
            performConfigImport(config);
        }
    );
}

function performConfigImport(config) {
    showProgressModal('Importando configuraci√≥n...', 'Aplicando nueva configuraci√≥n');
    
    fetch('/api/configuration/import', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Configuraci√≥n importada exitosamente');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification('error', 'Error al importar configuraci√≥n: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error importing configuration:', error);
        showNotification('error', 'Error al importar configuraci√≥n');
    })
    .finally(() => {
        closeModal('progressModal');
    });
}

function resetToDefaults() {
    showConfirmModal(
        'Restaurar Configuraci√≥n',
        '¬øEst√°s seguro de que deseas restaurar la configuraci√≥n a los valores por defecto? Esta acci√≥n no se puede deshacer.',
        () => {
            performConfigReset();
        }
    );
}

function performConfigReset() {
    showProgressModal('Restaurando configuraci√≥n...', 'Aplicando valores por defecto');
    
    fetch('/api/configuration/reset', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Configuraci√≥n restaurada exitosamente');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification('error', 'Error al restaurar configuraci√≥n');
        }
    })
    .catch(error => {
        console.error('Error resetting configuration:', error);
        showNotification('error', 'Error al restaurar configuraci√≥n');
    })
    .finally(() => {
        closeModal('progressModal');
    });
}

// ========== FUNCIONES DE VALIDACI√ìN ========== 
function validateEmail(event) {
    const field = event.target;
    const email = field.value;
    
    if (email && !isValidEmail(email)) {
        field.classList.add('error-shake');
        showNotification('warning', 'Email inv√°lido');
        setTimeout(() => {
            field.classList.remove('error-shake');
        }, 500);
    }
}

function validateURL(event) {
    const field = event.target;
    const url = field.value;
    
    if (url && !isValidURL(url)) {
        field.classList.add('error-shake');
        showNotification('warning', 'URL inv√°lida');
        setTimeout(() => {
            field.classList.remove('error-shake');
        }, 500);
    }
}

function validateNumber(event) {
    const field = event.target;
    const value = parseFloat(field.value);
    const min = parseFloat(field.getAttribute('min'));
    const max = parseFloat(field.getAttribute('max'));
    
    if (field.value && (isNaN(value) || 
        (min !== null && value < min) || 
        (max !== null && value > max))) {
        field.classList.add('error-shake');
        showNotification('warning', 'Valor num√©rico inv√°lido');
        setTimeout(() => {
            field.classList.remove('error-shake');
        }, 500);
    }
}

function validateIPs() {
    const field = document.getElementById('allowed_ips');
    const ips = field.value.split('\n').filter(ip => ip.trim() !== '');
    
    let invalidIPs = [];
    ips.forEach(ip => {
        if (!isValidIPOrCIDR(ip.trim())) {
            invalidIPs.push(ip.trim());
        }
    });
    
    if (invalidIPs.length > 0) {
        showNotification('error', `IPs inv√°lidas: ${invalidIPs.join(', ')}`);
    } else {
        showNotification('success', 'Todas las IPs son v√°lidas');
    }
}

function addCurrentIP() {
    fetch('/api/system/current-ip')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const field = document.getElementById('allowed_ips');
            const currentIPs = field.value;
            field.value = currentIPs + (currentIPs ? '\n' : '') + data.ip;
            debounceAutoSave();
            showNotification('success', `IP actual agregada: ${data.ip}`);
        }
    })
    .catch(error => {
        showNotification('error', 'Error al obtener IP actual');
    });
}

// ========== FUNCIONES DE EMAIL ========== 
function testEmailConfig() {
    const emailData = {
        smtp_server: document.getElementById('smtp_server').value,
        smtp_port: document.getElementById('smtp_port').value,
        smtp_username: document.getElementById('smtp_username').value,
        smtp_password: document.getElementById('smtp_password').value,
        smtp_from_email: document.getElementById('smtp_from_email').value
    };
    
    if (!emailData.smtp_server || !emailData.smtp_username) {
        showNotification('warning', 'Completa la configuraci√≥n SMTP antes de probar');
        return;
    }
    
    showProgressModal('Enviando email de prueba...', 'Verificando configuraci√≥n SMTP');
    
    fetch('/api/configuration/test-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(emailData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Email de prueba enviado exitosamente');
        } else {
            showNotification('error', 'Error al enviar email: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error testing email:', error);
        showNotification('error', 'Error al probar configuraci√≥n de email');
    })
    .finally(() => {
        closeModal('progressModal');
    });
}

function validateEmailConfig() {
    const config = {
        smtp_server: document.getElementById('smtp_server').value,
        smtp_port: document.getElementById('smtp_port').value,
        smtp_username: document.getElementById('smtp_username').value
    };
    
    if (!config.smtp_server || !config.smtp_port || !config.smtp_username) {
        showNotification('warning', 'Completa todos los campos obligatorios');
        return;
    }
    
    showNotification('success', 'Configuraci√≥n de email v√°lida');
}

// ========== FUNCIONES DE MANTENIMIENTO ========== 
function createBackup() {
    showConfirmModal(
        'Crear Backup',
        '¬øDeseas crear un backup completo del sistema? Esto puede tomar varios minutos.',
        () => {
            performBackup();
        }
    );
}

function performBackup() {
    showProgressModal('Creando backup...', 'Generando copia de seguridad completa');
    
    fetch('/api/maintenance/backup', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Backup creado exitosamente');
        } else {
            showNotification('error', 'Error al crear backup: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating backup:', error);
        showNotification('error', 'Error al crear backup');
    })
    .finally(() => {
        closeModal('progressModal');
    });
}

function optimizeDatabase() {
    showConfirmModal(
        'Optimizar Base de Datos',
        '¬øDeseas optimizar la base de datos? Esto mejorar√° el rendimiento pero puede tomar tiempo.',
        () => {
            performDatabaseOptimization();
        }
    );
}

function performDatabaseOptimization() {
    showProgressModal('Optimizando base de datos...', 'Ejecutando tareas de optimizaci√≥n');
    
    fetch('/api/maintenance/optimize-db', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Base de datos optimizada exitosamente');
        } else {
            showNotification('error', 'Error al optimizar base de datos');
        }
    })
    .catch(error => {
        console.error('Error optimizing database:', error);
        showNotification('error', 'Error al optimizar base de datos');
    })
    .finally(() => {
        closeModal('progressModal');
    });
}

function clearCache() {
    fetch('/api/maintenance/clear-cache', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Cache limpiado exitosamente');
        } else {
            showNotification('error', 'Error al limpiar cache');
        }
    })
    .catch(error => {
        console.error('Error clearing cache:', error);
        showNotification('error', 'Error al limpiar cache');
    });
}

function clearAllLogs() {
    showConfirmModal(
        'Limpiar Logs',
        '¬øEst√°s seguro de que deseas eliminar todos los logs? Esta acci√≥n no se puede deshacer.',
        () => {
            performLogCleanup();
        }
    );
}

function performLogCleanup() {
    fetch('/api/maintenance/clear-logs', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Logs eliminados exitosamente');
        } else {
            showNotification('error', 'Error al eliminar logs');
        }
    })
    .catch(error => {
        console.error('Error clearing logs:', error);
        showNotification('error', 'Error al eliminar logs');
    });
}

function checkForUpdates() {
    showProgressModal('Buscando actualizaciones...', 'Verificando versiones disponibles');
    
    fetch('/api/maintenance/check-updates', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.updates_available) {
                showNotification('info', `Actualizaci√≥n disponible: ${data.latest_version}`);
            } else {
                showNotification('success', 'El sistema est√° actualizado');
            }
        } else {
            showNotification('error', 'Error al verificar actualizaciones');
        }
    })
    .catch(error => {
        console.error('Error checking updates:', error);
        showNotification('error', 'Error al verificar actualizaciones');
    })
    .finally(() => {
        closeModal('progressModal');
    });
}

function generateSystemReport() {
    showProgressModal('Generando reporte...', 'Recopilando informaci√≥n del sistema');
    
    fetch('/api/maintenance/system-report', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Error al generar reporte');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `erp13_system_report_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification('success', 'Reporte generado exitosamente');
    })
    .catch(error => {
        console.error('Error generating report:', error);
        showNotification('error', 'Error al generar reporte');
    })
    .finally(() => {
        closeModal('progressModal');
    });
}

function downloadSystemLogs() {
    fetch('/api/maintenance/download-logs', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Error al descargar logs');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `erp13_logs_${new Date().toISOString().split('T')[0]}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification('success', 'Logs descargados exitosamente');
    })
    .catch(error => {
        console.error('Error downloading logs:', error);
        showNotification('error', 'Error al descargar logs');
    });
}

// ========== UTILIDADES Y HELPERS ========== 
function getCSRFToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function isValidURL(url) {
    try {
        new URL(url);
        return true;
    } catch {
        return false;
    }
}

function isValidIPOrCIDR(ip) {
    // Validaci√≥n b√°sica de IP/CIDR
    const ipRegex = /^(\d{1,3}\.){3}\d{1,3}(\/\d{1,2})?$/;
    return ipRegex.test(ip);
}

function handleFileUpload(field, module, key) {
    const file = field.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('module', module);
    formData.append('key', key);
    
    fetch('/api/configuration/upload-file', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Archivo subido exitosamente');
        } else {
            showNotification('error', 'Error al subir archivo: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error uploading file:', error);
        showNotification('error', 'Error al subir archivo');
    });
}

// ========== GESTI√ìN DE MODALES ========== 
function showConfirmModal(title, message, confirmCallback) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmButton').onclick = function() {
        confirmCallback();
        closeModal('confirmModal');
    };
    document.getElementById('confirmModal').classList.add('show');
}

function showProgressModal(title, message) {
    document.getElementById('progressTitle').textContent = title;
    document.getElementById('progressMessage').textContent = message;
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressModal').classList.add('show');
    
    // Simular progreso
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        document.getElementById('progressBar').style.width = progress + '%';
    }, 300);
    
    // Guardar interval para poder limpiarlo
    document.getElementById('progressModal').dataset.interval = interval;
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    
    // Limpiar interval si existe
    if (modal.dataset.interval) {
        clearInterval(modal.dataset.interval);
        delete modal.dataset.interval;
    }
}

function closeAllModals() {
    const modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(modal => {
        modal.classList.remove('show');
        if (modal.dataset.interval) {
            clearInterval(modal.dataset.interval);
            delete modal.dataset.interval;
        }
    });
}

// ========== SISTEMA DE NOTIFICACIONES ========== 
function showNotification(type, message) {
    const notification = document.getElementById('notification');
    const icon = notification.querySelector('i');
    const text = document.getElementById('notificationText');
    
    // Remover clases anteriores
    notification.className = 'notification';
    
    // Configurar icono y clase seg√∫n tipo
    switch(type) {
        case 'success':
            notification.classList.add('success');
            icon.className = 'fas fa-check';
            break;
        case 'error':
            notification.classList.add('error');
            icon.className = 'fas fa-times';
            break;
        case 'warning':
            notification.classList.add('warning');
            icon.className = 'fas fa-exclamation-triangle';
            break;
        case 'info':
            notification.classList.add('info');
            icon.className = 'fas fa-info-circle';
            break;
        case 'saving':
            notification.classList.add('info');
            icon.className = 'fas fa-spinner fa-spin';
            break;
    }
    
    text.textContent = message;
    notification.classList.add('show');
    
    // Auto-ocultar despu√©s de 4 segundos (excepto para saving)
    if (type !== 'saving') {
        setTimeout(() => {
            notification.classList.remove('show');
        }, 4000);
    }
}

function showSaveIndicator(type) {
    if (type === 'saving') {
        showNotification('saving', 'Guardando configuraci√≥n...');
    }
}

// ========== ACTUALIZACI√ìN DE UI ========== 
function updateSystemInfoDisplay() {
    // Actualizar cards de estado si est√°n disponibles
    if (systemInfo.uptime) {
        const uptimeCard = document.querySelector('.status-card.success .card-value');
        if (uptimeCard && systemInfo.uptime_percentage) {
            uptimeCard.textContent = systemInfo.uptime_percentage + '%';
        }
    }
    
    if (systemInfo.storage_usage) {
        const storageCard = document.querySelector('.status-card.warning .card-value');
        if (storageCard) {
            storageCard.textContent = systemInfo.storage_usage + '%';
        }
    }
    
    if (systemInfo.active_users) {
        const usersCard = document.querySelector('.status-card.info .card-value');
        if (usersCard) {
            usersCard.textContent = systemInfo.active_users;
        }
    }
}

// ========== M√âTODOS DE CARGA ESPEC√çFICOS ========== 
function loadSystemMetrics() {
    fetch('/api/system/metrics')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSystemMetrics(data.metrics);
        }
    })
    .catch(error => {
        console.error('Error loading system metrics:', error);
    });
}

function loadSecurityStatus() {
    fetch('/api/security/status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSecurityStatus(data.status);
        }
    })
    .catch(error => {
        console.error('Error loading security status:', error);
    });
}

function loadMaintenanceInfo() {
    fetch('/api/maintenance/info')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateMaintenanceInfo(data.info);
        }
    })
    .catch(error => {
        console.error('Error loading maintenance info:', error);
    });
}

function updateSystemMetrics(metrics) {
    // Implementar actualizaci√≥n de m√©tricas del sistema
    console.log('System metrics:', metrics);
}

function updateSecurityStatus(status) {
    // Implementar actualizaci√≥n de estado de seguridad
    console.log('Security status:', status);
}

function updateMaintenanceInfo(info) {
    // Implementar actualizaci√≥n de informaci√≥n de mantenimiento
    console.log('Maintenance info:', info);
}

// ========== BEFORE UNLOAD WARNING ========== 
window.addEventListener('beforeunload', function(e) {
    if (isConfigDirty) {
        const confirmationMessage = 'Tienes cambios sin guardar. ¬øEst√°s seguro de que quieres salir?';
        e.returnValue = confirmationMessage;
        return confirmationMessage;
    }
});

// ========== RESPONSIVE HELPERS ========== 
function handleResponsiveChanges() {
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        document.body.classList.add('mobile-view');
    } else {
        document.body.classList.remove('mobile-view');
    }
}

window.addEventListener('resize', debounce(handleResponsiveChanges, 250));

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Inicializar responsive
handleResponsiveChanges();

// ========== EXPORT PARA TESTING ========== 
window.ERP13Config = {
    switchTab,
    forceSaveConfiguration,
    exportSystemConfig,
    importSystemConfig,
    resetToDefaults,
    validateIPs,
    testEmailConfig,
    createBackup,
    optimizeDatabase,
    clearCache
};
</script>
{% endblock %}
